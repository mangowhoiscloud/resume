# Character Domain API

> AI ìºë¦­í„° ê´€ë¦¬ ë° íŽ˜ë¥´ì†Œë‚˜ ì„œë¹„ìŠ¤

---

## Overview

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì„œë¹„ìŠ¤** | Character API + Character Worker |
| **í”„ë¡œí† ì½œ** | HTTP REST + gRPC (Dual Interface) |
| **ìºì‹±** | Local Cache Broadcast (sync.Map + RabbitMQ) |
| **íŠ¹ì§•** | ìºë¦­í„°ë³„ íŽ˜ë¥´ì†Œë‚˜, ì‘ë‹µ ìŠ¤íƒ€ì¼ ê´€ë¦¬ |

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Character Domain                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚   HTTP API   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   gRPC API   â”‚          â”‚
â”‚   â”‚  (External)  â”‚                    â”‚  (Internal)  â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                                   â”‚                   â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â–¼                                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚          â”‚      Character Service      â”‚                        â”‚
â”‚          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                        â”‚
â”‚          â”‚   â”‚   Local Cache       â”‚   â”‚  â—€â”€â”€â”€ sync.Map         â”‚
â”‚          â”‚   â”‚   (In-Memory)       â”‚   â”‚       ~100ns lookup    â”‚
â”‚          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                         â”‚                                        â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚          â”‚              â–¼              â”‚                        â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                        â”‚
â”‚          â”‚  â”‚     PostgreSQL      â”‚    â”‚                        â”‚
â”‚          â”‚  â”‚   (Characters DB)   â”‚    â”‚                        â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                        â”‚
â”‚          â”‚                              â”‚                        â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                        â”‚
â”‚          â”‚  â”‚     RabbitMQ        â”‚    â”‚  Cache Invalidation    â”‚
â”‚          â”‚  â”‚  (Fanout Exchange)  â”‚    â”‚  Broadcast             â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                    Data Layer                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Endpoints

### HTTP REST API

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/characters` | ìºë¦­í„° ëª©ë¡ ì¡°íšŒ |
| `GET` | `/characters/{id}` | ìºë¦­í„° ìƒì„¸ ì¡°íšŒ |
| `POST` | `/characters` | ìºë¦­í„° ìƒì„± (Admin) |
| `PUT` | `/characters/{id}` | ìºë¦­í„° ìˆ˜ì • (Admin) |
| `DELETE` | `/characters/{id}` | ìºë¦­í„° ì‚­ì œ (Admin) |

### gRPC Service (Internal)

```protobuf
service CharacterService {
  // Chat Workerì—ì„œ í˜¸ì¶œ - ìºë¦­í„° íŽ˜ë¥´ì†Œë‚˜ ì¡°íšŒ
  rpc GetCharacter(GetCharacterRequest) returns (CharacterResponse);

  // ìºë¦­í„° ëª©ë¡ ì¡°íšŒ
  rpc ListCharacters(ListCharactersRequest) returns (ListCharactersResponse);

  // ìºë¦­í„° ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
  rpc ValidateCharacter(ValidateCharacterRequest) returns (ValidateResponse);
}
```

---

## Key Implementation Patterns

### 1. Local Cache Broadcast Pattern

Chat Workerì˜ LangGraph íŒŒì´í”„ë¼ì¸ì—ì„œ ìºë¦­í„° ì •ë³´ ì¡°íšŒ ì‹œ ë§¤ë²ˆ gRPC í˜¸ì¶œí•˜ë©´ ì§€ì—° ë°œìƒ. Local Cacheë¡œ ~100ns ì¡°íšŒ ë‹¬ì„±.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod A      â”‚     â”‚  Pod B      â”‚     â”‚  Pod C      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cache â”‚  â”‚     â”‚  â”‚ Cache â”‚  â”‚     â”‚  â”‚ Cache â”‚  â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  RabbitMQ   â”‚
                    â”‚   Fanout    â”‚
                    â”‚  Exchange   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ Character   â”‚
                    â”‚   Update    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Character ë³€ê²½ ë°œìƒ
2. RabbitMQ Fanoutìœ¼ë¡œ ëª¨ë“  Podì— ë¸Œë¡œë“œìºìŠ¤íŠ¸
3. ê° Podì˜ Local Cache ë™ê¸°í™”
4. ë‹¤ìŒ ìš”ì²­ë¶€í„° ~100ns ì¡°íšŒ
```

### 2. Dual Interface (HTTP + gRPC)

- **HTTP**: ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ (Frontend, Admin)
- **gRPC**: ë‚´ë¶€ ì„œë¹„ìŠ¤ (Chat Worker, LangGraph Pipeline)

### 3. Character Persona

```python
@dataclass
class CharacterPersona:
    id: str
    name: str
    description: str
    personality: str        # ì„±ê²© íŠ¹ì„±
    speaking_style: str     # ë§íˆ¬ ìŠ¤íƒ€ì¼
    emoji_usage: str        # ì´ëª¨ì§€ ì‚¬ìš© ì •ë„
    system_prompt: str      # LLM System Prompt
```

---

## Character Types

| ìºë¦­í„° | ì„¤ëª… | ë§íˆ¬ ìŠ¤íƒ€ì¼ |
|--------|------|-------------|
| ðŸŒ ì—ì½” | ê¸°ë³¸ í™˜ê²½ ìºë¦­í„° | ì¹œê·¼í•˜ê³  ê²©ì‹ì²´ |
| ðŸ± ê³ ì–‘ì´ | ê·€ì—¬ìš´ ê³ ì–‘ì´ | ~ëƒ¥, ê·€ì—¬ìš´ í‘œí˜„ |
| ðŸ¤– ë¡œë´‡ | AI ì–´ì‹œìŠ¤í„´íŠ¸ | ì •ì¤‘í•˜ê³  ì •í™• |

---

## Chat Worker Integration

```python
# LangGraph character_nodeì—ì„œ gRPC í˜¸ì¶œ
async def character_node(state: ChatState) -> dict:
    character_id = state.get("character_id")

    # gRPCë¡œ ìºë¦­í„° ì •ë³´ ì¡°íšŒ (Local Cache í™œìš©)
    character = await character_client.get_character(character_id)

    return {
        "character_persona": character.system_prompt,
        "speaking_style": character.speaking_style,
    }
```

---

## Infrastructure

- **Kubernetes**: Deployment + HPA
- **PostgreSQL**: Character ë°ì´í„° ì €ìž¥
- **RabbitMQ**: Fanout Exchange (cache invalidation)
- **gRPC**: Internal service mesh

---

## Performance

| Metric | Value |
|--------|-------|
| Local Cache Lookup | ~100ns |
| gRPC Cold Call | ~5ms |
| Cache Hit Rate | >95% |
