# Recycle Agent í¬íŠ¸í´ë¦¬ì˜¤ ìµœì‹ í™” ë¦¬í¬íŠ¸

> **Date:** 2026-01-18
> **Scope:** eco2-portfolio.html - Recycling Agent ì„¹ì…˜
> **Status:** ë¶„ì„ ì™„ë£Œ, HTML ìˆ˜ì • ëŒ€ê¸°

---

## 1. Executive Summary

eco2-portfolio.htmlì˜ Recycling Agent ì„¹ì…˜ì´ ì•½ 2ì£¼ê°„ outdated ìƒíƒœì…ë‹ˆë‹¤. ë¸”ë¡œê·¸ ìµœì‹  ê¸€(2026.1.16-1.18), ì½”ë“œë² ì´ìŠ¤(`apps/chat_worker`), docs/reports ë¬¸ì„œë¥¼ ë¶„ì„í•˜ì—¬ ì•„ë˜ í•µì‹¬ ë³€ê²½ì‚¬í•­ì„ ì‹ë³„í–ˆìŠµë‹ˆë‹¤.

**í˜„ì¬ ìƒíƒœ**: "ì§„í–‰ ì¤‘" â†’ **ë³€ê²½ ê¶Œì¥**: "ë°°í¬ ì™„ë£Œ, E2E í…ŒìŠ¤íŠ¸ ì¤‘"

### í•µì‹¬ ë³€ê²½ ìš”ì•½

| ì˜ì—­ | í˜„ì¬ (í¬íŠ¸í´ë¦¬ì˜¤) | ìµœì‹  (ì½”ë“œë² ì´ìŠ¤) |
|------|------------------|------------------|
| Intent ë¶„ë¥˜ | 4ë¶„ë¥˜ | **9ë¶„ë¥˜** |
| ë¼ìš°íŒ… | ìˆœì°¨ ì‹¤í–‰ | **Send API ë³‘ë ¬** |
| ë©”ëª¨ë¦¬ ê³„ì¸µ | ë¯¸ì–¸ê¸‰ | **3-Tier (Redis + PostgreSQL)** |
| í† í° ìŠ¤íŠ¸ë¦¬ë° | ê¸°ë³¸ | **Token v2 (ë³µêµ¬ ê°€ëŠ¥)** |
| ì»¨í…ìŠ¤íŠ¸ ì••ì¶• | ê³ ì • 3K | **ë™ì  (OpenCode ìŠ¤íƒ€ì¼)** |

---

## 2. ë¸”ë¡œê·¸ ìµœì‹  ê¸€ ë¶„ì„ (2026.1.16-1.18)

### ì¹´í…Œê³ ë¦¬: [ì´ì½”ì—ì½”(EcoÂ²)/Agent](https://rooftopsnow.tistory.com/category/ì´ì½”ì—ì½”(EcoÂ²)/Agent)

| ë‚ ì§œ | ì œëª© | URL | í•µì‹¬ ë‚´ìš© |
|------|------|-----|----------|
| 1.18 | Code Review: Chat Queuing & Event Bus | [#210](https://rooftopsnow.tistory.com/210) | RabbitMQ + Redis Streams ë¶„ë¦¬, Aì•ˆ íŒ¨í„´ |
| 1.17 | Agent #24: Multi-Agent Image Generation | [#207](https://rooftopsnow.tistory.com/207) | ìºë¦­í„° ì°¸ì¡° ì´ë¯¸ì§€ ìƒì„±, OpenAI Responses API |
| 1.17 | Agent #23: Observability - LangSmith + Prometheus | [#203](https://rooftopsnow.tistory.com/203) | íŒŒì´í”„ë¼ì¸ ëª¨ë‹ˆí„°ë§, ë¶€í•˜í…ŒìŠ¤íŠ¸ ë©”íŠ¸ë¦­ |
| 1.16 | Agent #21: ë™ì  ì»¨í…ìŠ¤íŠ¸ ì••ì¶• | [#200](https://rooftopsnow.tistory.com/200) | OpenCode ìŠ¤íƒ€ì¼, PRUNE_PROTECT 40K |
| 1.16 | Agent #20: Chat Worker Production Ready | [#198](https://rooftopsnow.tistory.com/198) | ê³ ë¶€í•˜ ëŒ€ì‘, Event-First ì„¤ê³„ |
| 1.16 | Agent #19: LangGraph Send API ê¸°ë°˜ ë™ì  ë¼ìš°íŒ… | [#196](https://rooftopsnow.tistory.com/196) | Multi-Intent ë³‘ë ¬ ì²˜ë¦¬, Enrichment Rules |
| 1.16 | Agent #18: ì™¸ë¶€ API ì—°ë™ | [#195](https://rooftopsnow.tistory.com/195) | í–‰ì •ì•ˆì „ë¶€, ê¸°ìƒì²­, KECO API |
| 1.16 | Agent #17: Image Generation | [#194](https://rooftopsnow.tistory.com/194) | OpenAI Responses API ë„¤ì´í‹°ë¸Œ ìƒì„± |

---

## 3. Chat_id / Job_id ê¸°ë°˜ ë°ì´í„° ì €ì¥ êµ¬ì¡°

### 3.1 ì‹ë³„ì ì²´ê³„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ID ì²´ê³„ ë° ê´€ê³„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  chat_id (UUID)                                              â”‚
â”‚  â”œâ”€ ìƒì„±: chat-api (ì„¸ì…˜ ìƒì„± ì‹œ)                            â”‚
â”‚  â”œâ”€ ì—­í• : ëŒ€í™” ì„¸ì…˜ ì‹ë³„                                     â”‚
â”‚  â”œâ”€ ë¼ì´í”„ì‚¬ì´í´: ì˜êµ¬ (ì‚¬ìš©ì ì‚­ì œê¹Œì§€)                     â”‚
â”‚  â””â”€ ì €ì¥: PostgreSQL (chat.conversations PK)                â”‚
â”‚           â”‚                                                  â”‚
â”‚           â”‚ = session_id = thread_id (LangGraph)            â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  job_id (UUID)                                               â”‚
â”‚  â”œâ”€ ìƒì„±: chat-api (ë©”ì‹œì§€ ì „ì†¡ ì‹œ)                          â”‚
â”‚  â”œâ”€ ì—­í• : ë‹¨ì¼ ìš”ì²­/ì‘ë‹µ ì¶”ì                                 â”‚
â”‚  â”œâ”€ ë¼ì´í”„ì‚¬ì´í´: ìš”ì²­ ì™„ë£Œê¹Œì§€ (TTL 1-24ì‹œê°„)              â”‚
â”‚  â””â”€ ì €ì¥: Redis (chat:state, chat:tokens, chat:events)      â”‚
â”‚           PostgreSQL (chat.messages.job_id FK nullable)      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 PostgreSQL ìŠ¤í‚¤ë§ˆ (ì˜êµ¬ ì €ì¥)

```sql
-- chat.conversations (ì„¸ì…˜)
CREATE TABLE chat.conversations (
    id              UUID PRIMARY KEY,           -- chat_id
    user_id         UUID NOT NULL,              -- FK â†’ users
    title           TEXT,
    preview         TEXT,                       -- ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°
    message_count   INTEGER DEFAULT 0,
    last_message_at TIMESTAMP WITH TIME ZONE,
    is_deleted      BOOLEAN DEFAULT FALSE,      -- soft delete
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- chat.messages (ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬)
CREATE TABLE chat.messages (
    id          UUID PRIMARY KEY,
    chat_id     UUID NOT NULL,                  -- FK â†’ conversations
    role        TEXT NOT NULL,                  -- 'user' | 'assistant'
    content     TEXT NOT NULL,
    intent      TEXT,                           -- ë¶„ë¥˜ëœ intent
    metadata    JSONB,                          -- ì¶”ê°€ ë©”íƒ€ë°ì´í„°
    job_id      UUID,                           -- ìš”ì²­ ì¶”ì  ID (nullable)
    created_at  TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- langgraph_checkpoints (LangGraph ìƒíƒœ)
-- thread_id = session_id = chat_id
```

### 3.3 Redis í‚¤ ì²´ê³„ (ì‹¤ì‹œê°„ + ìºì‹œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis í‚¤ ì²´ê³„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  [ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼] - Shard ê¸°ë°˜ ë¶„ì‚°                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ chat:events:{shard}           # 0,1,2,3 (4 shards)      â”‚ â”‚
â”‚  â”‚ â”œâ”€ ë¼ìš°íŒ…: hash(job_id) % 4                             â”‚ â”‚
â”‚  â”‚ â”œâ”€ Consumer Group: "eventrouter"                        â”‚ â”‚
â”‚  â”‚ â”œâ”€ MAXLEN: 10,000                                       â”‚ â”‚
â”‚  â”‚ â””â”€ ë°ì´í„°: {job_id, stage, status, progress, ts, ...}   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  [ìƒíƒœ KV] - job_id ê¸°ë°˜                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ chat:state:{job_id}           # ì§„í–‰ ìƒíƒœ                â”‚ â”‚
â”‚  â”‚ â”œâ”€ TTL: 3600 (1ì‹œê°„)                                    â”‚ â”‚
â”‚  â”‚ â”œâ”€ ì—…ë°ì´íŠ¸: Event Router (Lua Script)                  â”‚ â”‚
â”‚  â”‚ â””â”€ ìš©ë„: SSE ì¬ì—°ê²° ì‹œ í˜„ì¬ ìƒíƒœ ì¡°íšŒ                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  [Token v2 ìŠ¤íŠ¸ë¦¬ë°] - job_id ê¸°ë°˜ (ë³µêµ¬ ì§€ì›)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ chat:tokens:{job_id}          # Token Stream            â”‚ â”‚
â”‚  â”‚ â”œâ”€ TTL: 3600 (1ì‹œê°„)                                    â”‚ â”‚
â”‚  â”‚ â”œâ”€ ë°ì´í„°: {seq, content, node, ts}                     â”‚ â”‚
â”‚  â”‚ â””â”€ ìš©ë„: ì¬ì—°ê²° ì‹œ í† í° catch-up                        â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚ chat:token_state:{job_id}     # Token State (ìŠ¤ëƒ…ìƒ·)    â”‚ â”‚
â”‚  â”‚ â”œâ”€ TTL: 3600 (1ì‹œê°„)                                    â”‚ â”‚
â”‚  â”‚ â”œâ”€ ì €ì¥ ì£¼ê¸°: 10 í† í°ë§ˆë‹¤                               â”‚ â”‚
â”‚  â”‚ â””â”€ ë°ì´í„°: {last_seq, accumulated, completed}           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  [ì²´í¬í¬ì¸íŠ¸ ìºì‹œ] - thread_id(=chat_id) ê¸°ë°˜                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ chat:checkpoint:cache:{thread_id}                       â”‚ â”‚
â”‚  â”‚ â”œâ”€ TTL: 86400 (24ì‹œê°„)                                  â”‚ â”‚
â”‚  â”‚ â”œâ”€ L1 ìºì‹œ: Hot session ~1ms                            â”‚ â”‚
â”‚  â”‚ â””â”€ L2 fallback: PostgreSQL (langgraph_checkpoints)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  [Pub/Sub ì±„ë„] - job_id ê¸°ë°˜                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ sse:events:{job_id}           # SSE Gateway êµ¬ë…        â”‚ â”‚
â”‚  â”‚ â””â”€ Event Router â†’ PUBLISH â†’ SSE Gateway â†’ Browser       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  [ë°œí–‰ ë§ˆì»¤] - Idempotency                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ chat:published:{message_id}   # ì¤‘ë³µ ë°œí–‰ ë°©ì§€          â”‚ â”‚
â”‚  â”‚ â””â”€ TTL: 7200 (2ì‹œê°„)                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 ë°ì´í„° í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Chat ìš”ì²­ â†’ ì‘ë‹µ í”Œë¡œìš°                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â‘  ìš”ì²­ ìƒì„± (chat-api)                                                  â”‚
â”‚     POST /chat/{chat_id}/messages                                        â”‚
â”‚     â”œâ”€ job_id = uuid4()                                                 â”‚
â”‚     â”œâ”€ Message INSERT â†’ PostgreSQL (chat.messages)                      â”‚
â”‚     â””â”€ RabbitMQ PUBLISH â†’ chat_tasks exchange                           â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â‘¡ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (chat-worker)                                         â”‚
â”‚     LangGraph Pipeline (job_id ì¶”ì )                                     â”‚
â”‚     â”œâ”€ Intent â†’ Router â†’ Subagents (ë³‘ë ¬) â†’ Aggregator â†’ Answer         â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”œâ”€ ì§„í–‰ ì´ë²¤íŠ¸ ë°œí–‰                                                  â”‚
â”‚     â”‚   â””â”€ XADD chat:events:{shard} {job_id, stage, progress}           â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”œâ”€ í† í° ìŠ¤íŠ¸ë¦¬ë° (Token v2)                                          â”‚
â”‚     â”‚   â”œâ”€ XADD chat:tokens:{job_id} {seq, content, node}               â”‚
â”‚     â”‚   â””â”€ SETEX chat:token_state:{job_id} (10í† í°ë§ˆë‹¤)                 â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â””â”€ ì²´í¬í¬ì¸íŠ¸ ì €ì¥ (ë©€í‹°í„´ ëŒ€í™”)                                     â”‚
â”‚         â””â”€ PostgreSQL + Redis ìºì‹œ (thread_id = chat_id)                â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â‘¢ ì´ë²¤íŠ¸ ë¼ìš°íŒ… (event-router)                                          â”‚
â”‚     XREADGROUP chat:events:* â†’ Lua Script (atomic)                      â”‚
â”‚     â”œâ”€ SETEX chat:state:{job_id}       # ìƒíƒœ ì—…ë°ì´íŠ¸                  â”‚
â”‚     â”œâ”€ PUBLISH sse:events:{job_id}     # SSE ì „ë‹¬                       â”‚
â”‚     â””â”€ SETEX chat:published:{msg_id}   # idempotency                    â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â‘£ SSE ìŠ¤íŠ¸ë¦¬ë° (sse-gateway)                                            â”‚
â”‚     SUBSCRIBE sse:events:{job_id} â†’ Browser SSE                         â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â””â”€ ë³µêµ¬ ì§€ì› (ì¬ì—°ê²° ì‹œ)                                             â”‚
â”‚         â”œâ”€ GET chat:state:{job_id}         # í˜„ì¬ ìƒíƒœ                  â”‚
â”‚         â””â”€ XRANGE chat:tokens:{job_id}     # í† í° catch-up              â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â‘¤ ì™„ë£Œ í›„ ì˜êµ¬ ì €ì¥ (Eventual Consistency)                              â”‚
â”‚     chat-api Consumer (chat:events â†’ done ì´ë²¤íŠ¸ êµ¬ë…)                   â”‚
â”‚     â”œâ”€ Message UPDATE (answer, metadata) â†’ PostgreSQL                   â”‚
â”‚     â””â”€ Conversation UPDATE (preview, last_message_at)                   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ë©”ëª¨ë¦¬ ê³„ì¸µ ì„¤ê³„ (Memory Hierarchy)

### 4.1 3-Tier ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Memory Hierarchy (3-Tier)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tier 1: Redis (ì‹¤ì‹œê°„, TTL ê¸°ë°˜)                                   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  Token Stream (chat:tokens:{job_id})                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ ëª¨ë“  í† í° ì €ì¥ (Redis Streams)                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ TTL: 1ì‹œê°„                                                    â”‚  â”‚
â”‚  â”‚  â””â”€ ìš©ë„: ì¬ì—°ê²° ì‹œ catch-up                                      â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  Token State (chat:token_state:{job_id})                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ 10 í† í°ë§ˆë‹¤ ëˆ„ì  í…ìŠ¤íŠ¸ ìŠ¤ëƒ…ìƒ·                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ TTL: 1ì‹œê°„                                                    â”‚  â”‚
â”‚  â”‚  â””â”€ ìš©ë„: ì¦‰ì‹œ ë³µêµ¬ (XRANGE ì—†ì´)                                 â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  State KV (chat:state:{job_id})                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ ìµœì‹  íŒŒì´í”„ë¼ì¸ ìƒíƒœ                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ TTL: 1ì‹œê°„                                                    â”‚  â”‚
â”‚  â”‚  â””â”€ ìš©ë„: SSE ì¬ì—°ê²° ì‹œ í˜„ì¬ ìƒíƒœ ì¡°íšŒ                            â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  Checkpoint Cache (chat:checkpoint:cache:{thread_id})             â”‚  â”‚
â”‚  â”‚  â”œâ”€ LangGraph ì²´í¬í¬ì¸íŠ¸ L1 ìºì‹œ                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ TTL: 24ì‹œê°„                                                   â”‚  â”‚
â”‚  â”‚  â””â”€ ìš©ë„: Hot session ~1ms ì‘ë‹µ                                   â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼ Cache Miss                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tier 2: PostgreSQL (ì˜êµ¬ ì €ì¥)                                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  chat.conversations (ì„¸ì…˜ ë©”íƒ€ë°ì´í„°)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ user_id, title, preview, message_count                        â”‚  â”‚
â”‚  â”‚  â””â”€ ì‚¬ì´ë“œë°” ì±„íŒ… ëª©ë¡ìš©                                          â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  chat.messages (ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬)                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ chat_id, role, content, intent, job_id                        â”‚  â”‚
â”‚  â”‚  â””â”€ ëŒ€í™” ë‚´ì—­ ì˜êµ¬ ë³´ê´€                                           â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  langgraph_checkpoints (LangGraph ìƒíƒœ)                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ thread_id = session_id = chat_id                              â”‚  â”‚
â”‚  â”‚  â””â”€ ë©€í‹°í„´ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸                                          â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tier 3: Context Compression (OpenCode ìŠ¤íƒ€ì¼)                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  ModelContextConfig (ë™ì  ì„¤ì •)                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ GPT-5.2:    context=400K, output=128K, trigger=272K          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Gemini-3:   context=1M,   output=64K,  trigger=936K          â”‚  â”‚
â”‚  â”‚  â””â”€ Summary:    15% í• ë‹¹ (min 20K, max 65K)                       â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  ì••ì¶• íŠ¸ë¦¬ê±° (OpenCode isOverflow)                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ ì¡°ê±´: tokens > (context_window - max_output)                  â”‚  â”‚
â”‚  â”‚  â””â”€ PRUNE_PROTECT: 40K í† í° ë³´í˜¸ (ìµœê·¼ ì‘ì—…)                      â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  ìš”ì•½ êµ¬ì¡° (5ê°œ ì„¹ì…˜)                                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ ì‚¬ìš©ì ìš”ì²­ ì›ë¬¸                                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ ëª©í‘œ ë° ê¸°ëŒ€ ê²°ê³¼                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ ì™„ë£Œëœ ì‘ì—…                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ ì§„í–‰ ì¤‘/ë‚¨ì€ ì‘ì—…                                             â”‚  â”‚
â”‚  â”‚  â””â”€ ì¤‘ìš” ì»¨í…ìŠ¤íŠ¸                                                 â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 v1.0 vs v2.0 ë¹„êµ

| í•­ëª© | v1.0 (ê³ ì •) | v2.0 (ë™ì ) | ê°œì„ ìœ¨ |
|------|------------|------------|--------|
| Trigger ì„ê³„ê°’ | 3,072 tokens | 272,000 tokens (GPT-5.2) | **88x** |
| Summary í† í° | 512 tokens | 60,000 tokens | **117x** |
| ìµœê·¼ ë³´í˜¸ | 4 messages (~2K) | 40,000 tokens (~80 msgs) | **20x** |

---

## 5. ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ (Orchestration)

### 5.1 LangGraph Send API ê¸°ë°˜ ë™ì  ë¼ìš°íŒ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Dynamic Routing Architecture                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ì‚¬ìš©ì ë©”ì‹œì§€                                                            â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                 IntentClassifierService                              â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚  í‚¤ì›Œë“œ ë§µ ê¸°ë°˜ ì‹ ë¢°ë„ ë³´ì •                                    â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ WASTE:            ë²„ë ¤, ë²„ë¦¬, ë¶„ë¦¬, ì¬í™œìš©                â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ CHARACTER:        ìºë¦­í„°, ì–», ëª¨ì•„                        â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ LOCATION:         ì–´ë””, ê·¼ì²˜, ìœ„ì¹˜                        â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ BULK_WASTE:       ëŒ€í˜•íê¸°ë¬¼, ì†ŒíŒŒ, ëƒ‰ì¥ê³                â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ RECYCLABLE_PRICE: ì‹œì„¸, ê°€ê²©, ê³ ì² , íì§€                 â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ COLLECTION_POINT: ìˆ˜ê±°í•¨, ì˜ë¥˜ìˆ˜ê±°, íê±´ì „ì§€             â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ WEB_SEARCH:       ìµœì‹ , ë‰´ìŠ¤, ì •ì±…                       â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ IMAGE_GENERATION: ì´ë¯¸ì§€, ê·¸ë¦¼, ë³´ì—¬ì¤˜                   â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â””â”€ GENERAL:          ì•ˆë…•, ë­ì•¼                              â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                              â”‚                                       â”‚â”‚
â”‚  â”‚                              â–¼                                       â”‚â”‚
â”‚  â”‚  Multi-Intent Detection: "ì¢…ì´ ë²„ë¦¬ê³  ìˆ˜ê±°í•¨ë„ ì•Œë ¤ì¤˜"              â”‚â”‚
â”‚  â”‚  â”œâ”€ primary_intent: waste                                           â”‚â”‚
â”‚  â”‚  â””â”€ additional_intents: [collection_point]                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                           â”‚
â”‚                              â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Dynamic Router (Send API)                         â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  1. ì£¼ Intent ë…¸ë“œ                                                   â”‚â”‚
â”‚  â”‚     â””â”€ Send("waste_rag", state)                                     â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  2. Multi-Intent Fanout                                              â”‚â”‚
â”‚  â”‚     â””â”€ Send("collection_point", state)                              â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  3. Enrichment Rules (ìë™ ë³´ì¡° ë…¸ë“œ)                                â”‚â”‚
â”‚  â”‚     â”œâ”€ waste â†’ +weather (ë‚ ì”¨ ê¸°ë°˜ ë¶„ë¦¬ë°°ì¶œ íŒ)                     â”‚â”‚
â”‚  â”‚     â””â”€ bulk_waste â†’ +weather                                        â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  4. Conditional Enrichment                                           â”‚â”‚
â”‚  â”‚     â””â”€ user_location ìˆìŒ â†’ +weather                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                           â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚           â”‚                  â”‚                  â”‚                        â”‚
â”‚           â–¼                  â–¼                  â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚  waste_rag  â”‚    â”‚ collection  â”‚    â”‚   weather   â”‚                 â”‚
â”‚   â”‚ (Local JSON)â”‚    â”‚   _point    â”‚    â”‚ (ê¸°ìƒì²­ API)â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚          â”‚                  â”‚                  â”‚                        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                             â”‚ ë³‘ë ¬ ì‹¤í–‰                                  â”‚
â”‚                             â–¼                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                    â”‚ Aggregator Node â”‚  ê²°ê³¼ ìˆ˜ì§‘ + ê²€ì¦                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                             â”‚                                            â”‚
â”‚                             â–¼                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                     â”‚ Answer Node  â”‚  ìµœì¢… ë‹µë³€ ìƒì„± (ìŠ¤íŠ¸ë¦¬ë°)          â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 íŒŒì´í”„ë¼ì¸ ë…¸ë“œ (12ê°œ)

#### Pre-Intent ë…¸ë“œ (Intent ë¶„ë¥˜ ì „)

| Node | íŠ¸ë¦¬ê±° | ì™¸ë¶€ API | ì—­í•  |
|------|--------|----------|------|
| `vision` | image_url ì¡´ì¬ ì‹œ | **OpenAI Vision API** | ì´ë¯¸ì§€ ë¶„ë¥˜ (major/sub category) |

#### Intent â†’ Node ë§¤í•‘ (9ê°œ Intent â†’ 9ê°œ Node)

| Intent | Node | ì™¸ë¶€ API | Timeout |
|--------|------|----------|---------|
| `waste` | waste_rag | Local JSON Asset | 1s |
| `character` | character | gRPC (Character Service) | 3s |
| `location` | location | **Kakao Local API** | 5s |
| `bulk_waste` | bulk_waste | í–‰ì •ì•ˆì „ë¶€ API | 10s |
| `recyclable_price` | recyclable_price | í•œêµ­í™˜ê²½ê³µë‹¨ API | 5s |
| `collection_point` | collection_point | KECO API | 5s |
| `web_search` | web_search | DuckDuckGo / Tavily | 8s |
| `image_generation` | image_generation | OpenAI Responses API | 60s |
| `weather` | weather | ê¸°ìƒì²­ API (Enrichment) | 5s |
| `general` | general | LLM Only | - |
| `feedback` | feedback | í’ˆì§ˆ í‰ê°€ | - |

**Note**:
- `location` ë…¸ë“œ: ë‚´ë¶€ì ìœ¼ë¡œ `kakao_place_node` ì‚¬ìš© (gRPC LocationClientëŠ” deprecated)
- `weather` ë…¸ë“œ: Intent ë¼ìš°íŒ… + Enrichment ê·œì¹™ìœ¼ë¡œ ìë™ ì¶”ê°€

### 5.3 DynamicProgressTracker

```python
PHASE_PROGRESS = {
    "queued":     (0, 0),
    "intent":     (5, 15),
    "vision":     (15, 20),
    "subagents":  (20, 55),    # ë™ì  ê³„ì‚°
    "aggregator": (55, 65),
    "summarize":  (65, 75),
    "answer":     (75, 95),
    "done":       (100, 100),
}

# Subagent Progress ê³µì‹
# progress = base + (completed / total) * range
# ì˜ˆ: 3ê°œ í™œì„±í™”, 1ê°œ ì™„ë£Œ â†’ 20 + (1/3) * 35 = 32%
```

### 5.4 NodePolicy + FailMode

```python
class FailMode(Enum):
    FAIL_OPEN = "fail_open"       # ì‹¤íŒ¨í•´ë„ ì§„í–‰ (ë³´ì¡° ì •ë³´)
    FAIL_CLOSE = "fail_close"     # ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨ (í•„ìˆ˜)
    FAIL_FALLBACK = "fail_fallback"  # ëŒ€ì²´ ë…¸ë“œ ì‹¤í–‰

NODE_POLICIES = {
    "waste_rag":         FailMode.FAIL_FALLBACK,  # â†’ web_search
    "bulk_waste":        FailMode.FAIL_FALLBACK,  # â†’ web_search
    "weather":           FailMode.FAIL_OPEN,      # ë³´ì¡° ì •ë³´
    "character":         FailMode.FAIL_OPEN,      # ë³´ì¡° ì •ë³´
    "image_generation":  FailMode.FAIL_OPEN,      # ë³´ì¡° ì •ë³´
    "general":           FailMode.FAIL_CLOSE,     # ìµœí›„ì˜ ë³´ë£¨
}
```

---

## 6. Production Resilience

### 6.1 Timeout ì„¤ì •

| Component | Timeout | ì„¤ì • ìœ„ì¹˜ |
|-----------|---------|----------|
| Character gRPC | 3s | `grpc_client.py:96` |
| Location gRPC | 3s | `grpc_client.py:110` |
| Image Generator | connect=5s, read=60s | `openai_responses.py:78` |
| Task ì „ì²´ | 120s | `process_task.py` (Human-in-the-Loop ëŒ€ê¸° í¬í•¨) |

### 6.2 Circuit Breaker

```python
# InMemoryCircuitBreaker
circuit_breaker_threshold = 5  # 5íšŒ ì‹¤íŒ¨ ì‹œ ì°¨ë‹¨
reset_timeout = 60  # 60ì´ˆ í›„ ì¬ì‹œë„
```

### 6.3 IntentSignals

```python
@dataclass(frozen=True)
class IntentSignals:
    previous_intents: list[str]     # Chain-of-Intent
    has_image: bool                 # ì´ë¯¸ì§€ ì²¨ë¶€ ì—¬ë¶€
    user_location: dict | None      # ìœ„ì¹˜ ì •ë³´
```

---

## 7. Observability (LangSmith + Prometheus)

### 7.1 LangSmith (Feature-level Observability)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LangSmith ìë™ ìˆ˜ì§‘ ë©”íŠ¸ë¦­                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  í™˜ê²½ë³€ìˆ˜ ì„¤ì •ë§Œìœ¼ë¡œ ìë™ í™œì„±í™”:                                         â”‚
â”‚    LANGCHAIN_TRACING_V2=true                                            â”‚
â”‚    LANGCHAIN_API_KEY=lsv2_pt_xxxx                                       â”‚
â”‚    LANGCHAIN_PROJECT=eco2-chat-worker                                   â”‚
â”‚                                                                          â”‚
â”‚  ìë™ ìˆ˜ì§‘:                                                              â”‚
â”‚  â”œâ”€ Per-Node Latency    â†’ intent, vision, waste_rag ë“± ë…¸ë“œë³„ ì†Œìš”ì‹œê°„   â”‚
â”‚  â”œâ”€ Token Usage         â†’ ë…¸ë“œë³„ input/output í† í° ìˆ˜, ë¹„ìš© ì¶”ì •         â”‚
â”‚  â”œâ”€ Run Timeline        â†’ ë³‘ë ¬ ì‹¤í–‰ (Send API) ì‹œê°í™”                    â”‚
â”‚  â”œâ”€ Error Tracking      â†’ ë…¸ë“œë³„ ì—ëŸ¬ìœ¨, ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤                   â”‚
â”‚  â””â”€ Feedback Loop       â†’ RAG í’ˆì§ˆ í‰ê°€, Fallback ì²´ì¸ ì¶”ì               â”‚
â”‚                                                                          â”‚
â”‚  Jaeger OTEL ì—°ë™:                                                       â”‚
â”‚    LANGSMITH_OTEL_ENABLED=true                                          â”‚
â”‚    â†’ End-to-End Trace (chat-api â†’ chat-worker â†’ subagents)              â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Prometheus (ë¶€í•˜í…ŒìŠ¤íŠ¸ ë©”íŠ¸ë¦­)

| ë©”íŠ¸ë¦­ | ì„¤ëª… |
|--------|------|
| `chat_stream_requests_total` | ì´ ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ìˆ˜ |
| `chat_stream_active` | í˜„ì¬ í™œì„± ìŠ¤íŠ¸ë¦¼ ìˆ˜ |
| `chat_stream_duration_seconds` | ìŠ¤íŠ¸ë¦¬ë° ì†Œìš” ì‹œê°„ |
| `chat_stream_token_count` | ë°œí–‰ëœ í† í° ìˆ˜ |
| `chat_redis_latency_seconds` | Redis ì‘ì—… ì§€ì—°ì‹œê°„ |

### 7.3 Native Streaming (astream_events)

```python
# ê¸°ì¡´ ë°©ì‹ (ainvoke + ìˆ˜ë™ í† í° ë°œí–‰)
result = await graph.ainvoke(state)
for token in result["answer"]:
    await notify_token(token)  # ë©”íƒ€ë°ì´í„° ì—†ìŒ

# ì‹ ê·œ ë°©ì‹ (astream_events + ìë™ ë©”íƒ€ë°ì´í„°)
async for event in graph.astream_events(state, version="v2"):
    if event["event"] == "on_llm_stream":
        chunk = event["data"]["chunk"]
        node = event["metadata"]["langgraph_node"]  # ë°œìƒ ë…¸ë“œ ìë™ ì¶”ì 
        await notify_token_v2(chunk.content, node=node, step=event["metadata"]["langgraph_step"])
```

**ê°œì„ ì **:
- `ainvoke` â†’ `astream_events` ì „í™˜
- `metadata.langgraph_node`ë¡œ í† í° ë°œìƒ ë…¸ë“œ ìë™ ì¶”ì 
- Token Stream + Stateë¡œ ì¬ì—°ê²° ì‹œ ë³µêµ¬ ê°€ëŠ¥

---

## 8. Outdated í¬ì¸íŠ¸ ìƒì„¸

### 7.1 Recycling Agent ì¹´ë“œ (Line 2716-2783)

| í•­ëª© | í˜„ì¬ | ë³€ê²½ |
|------|------|------|
| ìƒíƒœ ë°°ì§€ | "ì§„í–‰ ì¤‘" | **"ë°°í¬ ì™„ë£Œ, E2E í…ŒìŠ¤íŠ¸ ì¤‘"** |
| Intent ë¶„ë¥˜ | 4ë¶„ë¥˜ | **9ë¶„ë¥˜** |
| Subagent | 2ê°œ (Character, Location) | **11ê°œ ë…¸ë“œ** |
| ë¼ìš°íŒ… | ìˆœì°¨ | **Send API ë³‘ë ¬** |
| ë©”ëª¨ë¦¬ ì–¸ê¸‰ | RedisSaverë§Œ | **3-Tier + Token v2** |

### 7.2 Chat Agentic Workflow ë‹¤ì´ì–´ê·¸ë¨ (Line 2954-2999)

```
í˜„ì¬:
  Intent â†’ Retriever â†’ Eval â†’ Fallback â†’ Answer

ë³€ê²½:
                      â”Œâ”€ waste_rag â”€â”€â”€â”€â”€â”€â”€â”
  Intent â”€â–¶ Router â”€â”€â–¶â”œâ”€ weather (Enrich)â”€â”¼â”€â”€â–¶ Aggregator â”€â–¶ Answer
  (9ë¶„ë¥˜)             â””â”€ collection_pointâ”€â”˜
                          (ë³‘ë ¬ Send)
```

### 7.3 Chat Infrastructure Modal (Line 6784-6943)

| í•­ëª© | í˜„ì¬ | ë³€ê²½ |
|------|------|------|
| íŒŒì´í”„ë¼ì¸ | ìˆœì°¨ | **ë³‘ë ¬ (Send API)** |
| í† í° ìŠ¤íŠ¸ë¦¬ë° | ê¸°ë³¸ notify_token | **Token v2 (ë³µêµ¬ ê°€ëŠ¥)** |
| Progress | ê³ ì • ë§µ | **DynamicProgressTracker** |
| ì»¨í…ìŠ¤íŠ¸ ì••ì¶• | ë¯¸ì–¸ê¸‰ | **OpenCode ìŠ¤íƒ€ì¼ ë™ì ** |

### 7.4 ê°œë°œ ì§„í–‰ ìƒí™© (Line 6925-6942)

```
í˜„ì¬:
âœ… LangGraph íŒŒì´í”„ë¼ì¸ êµ¬í˜„ ì™„ë£Œ
âœ… Intent Router + TagBasedRetriever ì ìš©
âœ… Eval Agent + Fallback Chain êµ¬í˜„
ğŸ”„ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë° SLA ì¸¡ì • ì˜ˆì •
ğŸ”„ Human-in-the-Loop ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ ì˜ˆì •

ë³€ê²½:
âœ… LangGraph Send API ë™ì  ë¼ìš°íŒ… (Multi-Intent ë³‘ë ¬)
âœ… 9ë¶„ë¥˜ Intent + Enrichment Rules
âœ… Token v2 ë³µêµ¬ ê°€ëŠ¥í•œ í† í° ìŠ¤íŠ¸ë¦¬ë°
âœ… Dynamic Context Compression (OpenCode ìŠ¤íƒ€ì¼)
âœ… Production Resilience (Timeout, Circuit Breaker, NodePolicy)
âœ… Observability (LangSmith + Prometheus í†µí•©)
âœ… ë°°í¬ ì™„ë£Œ (ArgoCD)
ğŸ”„ E2E í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘
```

---

## 9. ê¶Œì¥ ìˆ˜ì • ì‚¬í•­

### 8.1 HTML ìˆ˜ì • ëŒ€ìƒ

| ë¼ì¸ | ì„¹ì…˜ | ìˆ˜ì • ë‚´ìš© |
|------|------|----------|
| 2725-2728 | ìƒíƒœ ë°°ì§€ | "ì§„í–‰ ì¤‘" â†’ "ë°°í¬ ì™„ë£Œ" |
| 2736-2737 | ì„¤ëª… | 4ë¶„ë¥˜ â†’ 9ë¶„ë¥˜, ìˆœì°¨ â†’ ë³‘ë ¬ |
| 2750-2751 | Intent Router | 4ë¶„ë¥˜ â†’ 9ë¶„ë¥˜ + Multi-Intent |
| 2954-2999 | íŒŒì´í”„ë¼ì¸ ë‹¤ì´ì–´ê·¸ë¨ | ìˆœì°¨ â†’ ë³‘ë ¬ Send API |
| 6788-6789 | Modal ìƒíƒœ | "ì§„í–‰ ì¤‘" â†’ "ë°°í¬ ì™„ë£Œ" |
| 6805-6809 | íŒŒì´í”„ë¼ì¸ ì„¤ëª… | ë³‘ë ¬ ì‹¤í–‰, Aggregator ì¶”ê°€ |
| 6925-6942 | ê°œë°œ ìƒí™© | ì™„ë£Œ í•­ëª© ì—…ë°ì´íŠ¸ |

### 8.2 ì‹ ê·œ ì¶”ê°€ ê¶Œì¥ ì„¹ì…˜

1. **ë©”ëª¨ë¦¬ ê³„ì¸µ ì„¤ê³„**: 3-Tier êµ¬ì¡° ë‹¤ì´ì–´ê·¸ë¨
2. **Token v2 ìŠ¤íŠ¸ë¦¬ë°**: ë³µêµ¬ ê°€ëŠ¥í•œ í† í° ìŠ¤íŠ¸ë¦¬ë° ì„¤ëª…
3. **ë™ì  ì»¨í…ìŠ¤íŠ¸ ì••ì¶•**: OpenCode ìŠ¤íƒ€ì¼ ì„¤ì •
4. **Production Resilience**: NodePolicy, Timeout, Circuit Breaker

---

## 10. ì°¸ê³  ìë£Œ

### ë¸”ë¡œê·¸ (ê°œë³„ í¬ìŠ¤íŠ¸)
- [#210 Chat Queuing & Event Bus Consistency Report](https://rooftopsnow.tistory.com/210)
- [#207 Multi-Agent Image Generation](https://rooftopsnow.tistory.com/207)
- [#203 Observability - LangSmith + Prometheus](https://rooftopsnow.tistory.com/203)
- [#200 ë™ì  ì»¨í…ìŠ¤íŠ¸ ì••ì¶•](https://rooftopsnow.tistory.com/200)
- [#198 Chat Worker Production Ready](https://rooftopsnow.tistory.com/198)
- [#196 LangGraph Send API ê¸°ë°˜ ë™ì  ë¼ìš°íŒ…](https://rooftopsnow.tistory.com/196)
- [#195 ì™¸ë¶€ API ì—°ë™ (í–‰ì •ì•ˆì „ë¶€, ê¸°ìƒì²­, KECO)](https://rooftopsnow.tistory.com/195)
- [#194 Image Generation (OpenAI Responses API)](https://rooftopsnow.tistory.com/194)

### ì½”ë“œë² ì´ìŠ¤
- `apps/chat_worker/infrastructure/orchestration/langgraph/`
- `apps/chat_worker/infrastructure/events/redis_progress_notifier.py`
- `apps/event_router/`
- `apps/sse_gateway/`

### ë¬¸ì„œ
- `docs/reports/chat-queuing-strategy-analysis.md`
- `docs/reports/chat-worker-production-architecture-impl.md`
- `docs/blogs/applied/30-langgraph-dynamic-routing-send-api.md`
- `docs/blogs/applied/31-chat-dynamic-context-compression.md`
- `docs/blogs/applied/32-langgraph-native-streaming.md`

---

**ì‘ì„±ì¼**: 2026-01-18
**ì‘ì„±ì**: Claude Code
**ìƒíƒœ**: HTML ìˆ˜ì • ëŒ€ê¸°
